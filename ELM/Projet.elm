module Projet exposing (main)
import Browser
import Html exposing (..)
import Html.Events exposing (onClick, onInput)
import Html.Attributes exposing (..)
import Http
import Array
import Random
import Json.Decode exposing (Decoder, map, field, int, string, at, list)

type alias Model =
    { words : List String
     , currentOne : String
     , errorMessage : String
     , currentDef : String
     , currentDefList : (List String)
     , random : Int
     , guess : String
     , rightOrWrong : String
     , solution : String
     , score : Int
     , totalAttempt : Int
     , mode : String
    }

view : Model -> Html Msg
view model =
    div []
        [ 
              button [onClick GetRandomWord] [text "Get random word"]
            , button [onClick SwitchDifficulty] [text ("Switch mode (currently in " ++ model.mode ++ " mode)")]
            , div[][ text ("Score : " ++ (String.fromInt model.score) ++ "/" ++ (String.fromInt model.totalAttempt))]
            , br[][]
            , input [ placeholder "Guess word", value model.guess, onInput Change] []
            , button [onClick GuessWord] [text "Confirm word"]
            , button [onClick ShowSolution] [text "Show solution"]
            --, div [] [text model.errorMessage]
            --, viewRand model
            , viewRes model
            , br[][]
            --, viewWord model
            , viewDef model
            , br[][]
            , div[] [text model.solution]
        ]

viewRand : Model -> Html Msg
viewRand model=
    div[] [text (String.fromInt (model.random))]

viewRes : Model -> Html Msg
viewRes model=
    div[] [text (model.rightOrWrong)]

viewDef : Model -> Html Msg
viewDef model = 
    div[] [text (model.currentDef)]

viewGuess : Model -> Html Msg
viewGuess model = 
    div[] [text (model.guess)]

viewWord : Model-> Html Msg
viewWord model =
    div [] [text (model.currentOne)]

type Msg
    = DataReceived (Result Http.Error String)
    | DefReceived (Result Http.Error (List (List (List String))))
    | GetRandomWord
    | NewRandomNumber Int
    | GuessWord
    | Change String
    | ShowSolution
    | SwitchDifficulty
    | HandleHardMode Int 


url : String
url =
    "http://localhost:8000/wordList.txt"


update : Msg -> Model -> ( Model, Cmd Msg )
update msg model =
    case msg of
        GetRandomWord ->
            ( model, Random.generate NewRandomNumber (Random.int 0 999) )

        NewRandomNumber number ->
            let
                arr = Array.fromList model.words
                dudu = Array.get number arr
                a = Maybe.withDefault "........." dudu
            in
            ( {model | solution = "", random = number, currentOne = a, rightOrWrong = "Guess the word !"}, Http.get
                { url = "https://api.dictionaryapi.dev/api/v2/entries/en/" ++ a
                , expect = Http.expectJson DefReceived decoder1
                }
            )
        Change newContent ->
            ({ model | guess = newContent }, Cmd.none)
        
        ShowSolution ->
            if model.solution=="" && model.currentOne/=""
            then ({model | solution = model.currentOne, totalAttempt= model.totalAttempt+1}, Cmd.none)
            else (model, Cmd.none)

        GuessWord ->
            if model.currentOne == "" then ({model |rightOrWrong = "You haven't started the game !", guess = ""}, Cmd.none)
            else if model.guess == "" then ({model |rightOrWrong = "You haven't written anything...", guess=""}, Cmd.none)
            else if model.guess == model.currentOne && model.solution =="" then ({model |rightOrWrong = ("Yay, you found the word :)")
                                                                , guess = ""
                                                                , solution = model.currentOne
                                                                , score = model.score+1
                                                                , totalAttempt=model.totalAttempt+1}, Cmd.none)
            else if model.guess == model.currentOne && model.solution /="" then ({model |rightOrWrong = ("You're not getting points for that x)")
                                                                , guess = ""}, Cmd.none)
            else if model.solution=="" then ({model | rightOrWrong = "Try again !", guess = "", totalAttempt=model.totalAttempt+1}, Cmd.none)
            else ({model |  guess=""}, Cmd.none)
        DataReceived (Ok wordsStr) ->
            let
                words = String.split " " wordsStr
            in
            ( { model | words = words}, Cmd.none )

        DataReceived (Err httpError) ->
            ( { model
                | errorMessage = "Problem"
              }
            , Cmd.none
            )
        
        DefReceived (Ok res) ->
            if model.mode == "beginner" then
                (let
                    arr = Array.fromList res
                    subList = Array.get 0 arr
                    c = Maybe.withDefault ([["........."]]) subList
                    d = List.map (\def -> String.join " " def) c
                in
                ({model | currentDef = (String.join " " d), errorMessage = "received"}, Cmd.none))
            else 
                (let
                    arr = Array.fromList res
                    subList = Array.get 0 arr
                    b = Maybe.withDefault ([["........."]]) subList
                    arr2 = Array.fromList b
                    subList2 = Array.get 0 arr2
                    c = Maybe.withDefault (["........."]) subList2
                in
                ({model| currentDefList = c}, Random.generate HandleHardMode (Random.int 0 (List.length(c)-1))))
        
        HandleHardMode number ->
            let 
                arr = Array.fromList model.currentDefList
                randomDef = Maybe.withDefault ("") (Array.get number arr)
            in
            ({model| currentDef=randomDef}, Cmd.none)


        DefReceived (Err httpError) ->
            ( { model
                | errorMessage = "Problem with def"
              }
            , Cmd.none
            )
        SwitchDifficulty ->
            case model.mode of
                "beginner" ->({model | mode = "advanced"}, Cmd.none)
                "advanced" -> ({model | mode = "beginner"}, Cmd.none)
                _ -> (model, Cmd.none)   


decoder4 : Decoder String
decoder4 =
    field "definition" string

decoder3 = at ["definitions"] (Json.Decode.list decoder4)

decoder2 = at ["meanings"] (Json.Decode.list decoder3 )

decoder1 = Json.Decode.list decoder2


  

init : () -> ( Model, Cmd Msg )
init _ =
    ( { words = []
      , currentOne = "",
      errorMessage = "None",
      currentDef = ""
      , random = 0
      , guess = ""
      , rightOrWrong = "Start the game !"
      , solution = ""
      , score = 0
      , totalAttempt = 0
      , mode = "beginner"
      , currentDefList = []
      }
    ,   Http.get
        { url = "http://localhost:8000/wordList.txt"
        , expect = Http.expectString DataReceived
        }
    )


main : Program () Model Msg
main =
    Browser.element
        { init = init
        , view = view
        , update = update
        , subscriptions = \_ -> Sub.none
        }
